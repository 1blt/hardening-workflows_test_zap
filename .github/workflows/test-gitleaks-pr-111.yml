name: Test Gitleaks PR #111 Fix

# This tests the fix for: PR summary missing status when secrets found
# The bug: gitleaks exits non-zero which blocked the summary/PR comment step
# The fix: Summary should now be generated and PR comment posted even when secrets detected

on:
  pull_request:
    branches:
      - main

permissions:
  actions: read
  contents: read
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    name: "Security Hardening (Gitleaks Only)"
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@fix/gitleaks-PR-comment
    with:
      scanners: 'gitleaks'
      post_pr_comment: true
      allow_failure: true  # Don't fail the workflow, we just want to verify comment is posted
    secrets: inherit

  verify-pr-comment:
    name: "Verify PR Comment Created"
    runs-on: ubuntu-latest
    needs: security-scan
    if: always()
    steps:
      - name: Wait for comment to be posted
        run: sleep 10

      - name: Check for Security Hardening PR Comment
        id: check-comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for security hardening PR comment on PR #${{ github.event.pull_request.number }}..."

          # Look for the security-hardening-comment-marker
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq '.[] | select(.body | contains("security-hardening-comment-marker")) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            echo "SUCCESS: Found security hardening PR comment (ID: $COMMENT_ID)"
            echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT
            echo "comment_found=true" >> $GITHUB_OUTPUT
          else
            echo "FAILURE: No security hardening PR comment found"
            echo "comment_found=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Delete PR Comment (Cleanup)
        if: steps.check-comment.outputs.comment_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up: deleting PR comment ${{ steps.check-comment.outputs.comment_id }}"
          gh api -X DELETE repos/${{ github.repository }}/issues/comments/${{ steps.check-comment.outputs.comment_id }}
          echo "PR comment deleted successfully"

      - name: Report Result
        if: always()
        run: |
          echo "# Gitleaks PR #111 Test Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-comment.outputs.comment_found }}" == "true" ]; then
            echo "## PASS: PR comment was created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The fix works - security summary PR comment is posted even when secrets are detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "## FAIL: PR comment was NOT created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The bug may still exist - PR comment is missing when secrets are found." >> $GITHUB_STEP_SUMMARY
          fi
