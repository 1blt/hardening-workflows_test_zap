name: "Hardening Workflows Test Suite"

on:
  push:
    branches: [main]

  workflow_dispatch:
    inputs:
      scope:
        description: 'Test scope to run'
        required: true
        type: choice
        options:
          - all
          - unit
          - remote
          - discover
          - actions
          - combination
          - regression
          - scn
        default: 'all'

  schedule:
    # Weekly Sunday 9am UTC
    - cron: '0 9 * * 0'

concurrency:
  group: test-suite-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read
  pull-requests: write
  pages: write
  id-token: write

# ============================================================================
# Orchestrator: calls sub-workflows based on scope selection.
# Push to main and weekly schedule run 'all' scope.
# Concurrency group ensures only one run per ref at a time.
# ============================================================================

jobs:
  # ==========================================================================
  # Unit Tests (U1-U5)
  # ==========================================================================
  unit-tests:
    name: "Unit Tests"
    if: inputs.scope == 'all' || inputs.scope == 'unit' || github.event_name == 'schedule' || github.event_name == 'push'
    uses: ./.github/workflows/test-unit.yml

  # ==========================================================================
  # Direct Action Tests (A1-A5)
  # ==========================================================================
  action-tests:
    name: "Direct Action Tests"
    if: inputs.scope == 'all' || inputs.scope == 'actions' || github.event_name == 'schedule' || github.event_name == 'push'
    uses: ./.github/workflows/test-actions-direct.yml

  # ==========================================================================
  # Remote Mode Tests (R1-R12)
  # ==========================================================================
  remote-tests:
    name: "Remote Mode Tests"
    if: inputs.scope == 'all' || inputs.scope == 'remote' || github.event_name == 'schedule' || github.event_name == 'push'
    uses: ./.github/workflows/test-remote.yml

  # ==========================================================================
  # Discover Mode Tests (D1-D3)
  # ==========================================================================
  discover-tests:
    name: "Discover Mode Tests"
    if: inputs.scope == 'all' || inputs.scope == 'discover' || github.event_name == 'schedule' || github.event_name == 'push'
    uses: ./.github/workflows/test-discover.yml

  # ==========================================================================
  # Combination / Pairwise Tests (C1-C15)
  # ==========================================================================
  combination-tests:
    name: "Combination Tests"
    if: inputs.scope == 'all' || inputs.scope == 'combination' || github.event_name == 'schedule' || github.event_name == 'push'
    uses: ./.github/workflows/test-combination.yml

  # ==========================================================================
  # SCN Detector Tests (S1-S15)
  # ==========================================================================
  scn-tests:
    name: "SCN Detector Tests"
    if: inputs.scope == 'all' || inputs.scope == 'scn' || github.event_name == 'schedule' || github.event_name == 'push'
    uses: ./.github/workflows/test-scn-detector.yml

  # ==========================================================================
  # I1: Infrastructure scan regression
  # ==========================================================================
  i1-infrastructure-scan:
    name: "I1: infrastructure-scan regression"
    if: inputs.scope == 'all' || inputs.scope == 'regression' || github.event_name == 'schedule' || github.event_name == 'push'
    uses: huntridge-labs/hardening-workflows/.github/workflows/infrastructure-scan.yml@feat/migrate-to-composite-actions
    with:
      fail_on_severity: none

  # ==========================================================================
  # I2: No hardcoded URLs (inline regression check)
  # ==========================================================================
  i2-no-hardcoded-urls:
    name: "I2: no hardcoded URLs"
    if: inputs.scope == 'all' || inputs.scope == 'regression' || github.event_name == 'schedule' || github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout upstream PR branch
        uses: actions/checkout@v4
        with:
          repository: huntridge-labs/hardening-workflows
          ref: feat/migrate-to-composite-actions

      - name: Scan for hardcoded github.com in shell scripts
        run: |
          echo "Scanning container-related action scripts for hardcoded github.com URLs..."

          VIOLATIONS=0

          # Scan the container scanning composite actions
          SCAN_DIRS=(
            .github/actions/scanner-container
            .github/actions/scanner-container-summary
            .github/actions/parse-container-config
          )

          for dir in "${SCAN_DIRS[@]}"; do
            [ -d "$dir" ] || continue

            # Check .sh files (skip tests)
            while IFS= read -r script; do
              [[ "$script" == *"/tests/"* ]] && continue
              MATCHES=$(grep -n 'https://github\.com' "$script" 2>/dev/null | grep -v '^\s*#' | grep -v 'github\.server_url' | grep -v 'GITHUB_SERVER_URL' || true)
              if [ -n "$MATCHES" ]; then
                echo "VIOLATION: $script"
                echo "$MATCHES"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            done < <(find "$dir" -name "*.sh" -type f)

            # Check action.yml
            if [ -f "$dir/action.yml" ]; then
              MATCHES=$(grep -n 'https://github\.com' "$dir/action.yml" 2>/dev/null | grep -v '^\s*#' | grep -v 'github\.server_url' | grep -v 'GITHUB_SERVER_URL' | grep -v 'description:' || true)
              if [ -n "$MATCHES" ]; then
                echo "VIOLATION: $dir/action.yml"
                echo "$MATCHES"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done

          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "::error::Found $VIOLATIONS file(s) with hardcoded github.com URLs"
            exit 1
          fi

          echo "No hardcoded github.com URLs found in container scanning actions"

  # ==========================================================================
  # Final Summary
  # ==========================================================================
  summary:
    name: "Test Suite Summary"
    runs-on: ubuntu-latest
    needs:
      - unit-tests
      - action-tests
      - remote-tests
      - discover-tests
      - combination-tests
      - scn-tests
      - i1-infrastructure-scan
      - i2-no-hardcoded-urls
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Generate consolidated summary
        env:
          UNIT_JSON: ${{ needs.unit-tests.outputs.results }}
          ACTIONS_JSON: ${{ needs.action-tests.outputs.results }}
          REMOTE_JSON: ${{ needs.remote-tests.outputs.results }}
          DISCOVER_JSON: ${{ needs.discover-tests.outputs.results }}
          COMBO_JSON: ${{ needs.combination-tests.outputs.results }}
          SCN_JSON: ${{ needs.scn-tests.outputs.results }}
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          ACTIONS_RESULT: ${{ needs.action-tests.result }}
          REMOTE_RESULT: ${{ needs.remote-tests.result }}
          DISCOVER_RESULT: ${{ needs.discover-tests.result }}
          COMBO_RESULT: ${{ needs.combination-tests.result }}
          SCN_RESULT: ${{ needs.scn-tests.result }}
          I1: ${{ needs.i1-infrastructure-scan.result }}
          I2: ${{ needs.i2-no-hardcoded-urls.result }}
          SCOPE: ${{ inputs.scope || 'all' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          icon() {
            case "$1" in
              pass) echo ":white_check_mark:" ;;
              FAIL) echo ":x:" ;;
              skip) echo ":next_track_button:" ;;
              cancel) echo ":stop_sign:" ;;
              *) echo ":grey_question:" ;;
            esac
          }

          to_status() {
            case "$1" in
              success) echo "pass" ;;
              failure) echo "FAIL" ;;
              skipped) echo "skip" ;;
              cancelled) echo "cancel" ;;
              *) echo "unknown" ;;
            esac
          }

          # Merge all JSON arrays; use empty array for skipped/missing categories
          safe_json() {
            if [ -n "$1" ] && echo "$1" | jq empty 2>/dev/null; then
              echo "$1"
            else
              echo "[]"
            fi
          }

          UNIT_ARR=$(safe_json "$UNIT_JSON")
          ACTIONS_ARR=$(safe_json "$ACTIONS_JSON")
          REMOTE_ARR=$(safe_json "$REMOTE_JSON")
          DISCOVER_ARR=$(safe_json "$DISCOVER_JSON")
          COMBO_ARR=$(safe_json "$COMBO_JSON")
          SCN_ARR=$(safe_json "$SCN_JSON")

          # Build I1 and I2 inline (they're standalone jobs, not sub-workflows)
          I1_STATUS=$(to_status "$I1")
          I2_STATUS=$(to_status "$I2")
          REGRESSION_ARR=$(jq -n -c \
            --arg i1 "$I1_STATUS" \
            --arg i2 "$I2_STATUS" \
            '[
              {"id":"I1","name":"infrastructure-scan regression","detail":"infrastructure-scan.yml reusable workflow still works","status":$i1},
              {"id":"I2","name":"no hardcoded URLs","detail":"No hardcoded github.com in container action scripts","status":$i2}
            ]')

          # Merge all into one array
          ALL=$(jq -n -c \
            --argjson u "$UNIT_ARR" \
            --argjson a "$ACTIONS_ARR" \
            --argjson r "$REMOTE_ARR" \
            --argjson d "$DISCOVER_ARR" \
            --argjson c "$COMBO_ARR" \
            --argjson s "$SCN_ARR" \
            --argjson i "$REGRESSION_ARR" \
            '$u + $a + $r + $d + $c + $s + $i')

          # Export for dashboard generation step
          {
            echo "ALL_JSON<<GHEOF"
            echo "$ALL"
            echo "GHEOF"
            echo "REGRESSION_JSON<<GHEOF"
            echo "$REGRESSION_ARR"
            echo "GHEOF"
          } >> "$GITHUB_ENV"

          TOTAL=$(echo "$ALL" | jq 'length')
          PASSED=$(echo "$ALL" | jq '[.[] | select(.status == "pass")] | length')
          FAILED=$(echo "$ALL" | jq '[.[] | select(.status == "FAIL")] | length')
          SKIPPED=$(echo "$ALL" | jq '[.[] | select(.status == "skip" or .status == "cancel")] | length')
          RUNNABLE=$((TOTAL - SKIPPED))
          [ "$RUNNABLE" -eq 0 ] && RUNNABLE=1
          PASS_RATE=$((PASSED * 100 / RUNNABLE))

          if [ "$FAILED" -eq 0 ] && [ "$PASSED" -gt 0 ]; then
            VERDICT=":white_check_mark: **PASS**"
          else
            VERDICT=":x: **FAIL**"
          fi

          # Helper: count pass/fail/skip within a JSON array
          cat_icon() {
            case "$1" in
              success) echo ":white_check_mark:" ;;
              failure) echo ":x:" ;;
              skipped) echo ":next_track_button:" ;;
              cancelled) echo ":stop_sign:" ;;
              *) echo ":grey_question:" ;;
            esac
          }

          cat_counts() {
            local arr="$1"
            local p f s
            p=$(echo "$arr" | jq '[.[] | select(.status == "pass")] | length')
            f=$(echo "$arr" | jq '[.[] | select(.status == "FAIL")] | length')
            s=$(echo "$arr" | jq '[.[] | select(.status == "skip" or .status == "cancel")] | length')
            echo "$p/$((p + f + s))"
          }

          # ---- Write summary ----
          {
            echo "# Hardening Workflows Test Suite Results"
            echo ""
            echo "**Scope:** \`$SCOPE\` &nbsp; **Date:** $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo "**Verdict:** $VERDICT &nbsp; ($PASSED passed, $FAILED failed, $SKIPPED skipped â€” $PASS_RATE% pass rate)"
            echo ""
            echo "---"
            echo ""

            # ---- Category Overview ----
            echo "## Category Overview"
            echo ""
            echo "| Status | Category | Tests | Passed |"
            echo "|--------|----------|-------|--------|"
            echo "| $(cat_icon "$UNIT_RESULT") | Unit Tests (U1-U5) | 5 | $(cat_counts "$UNIT_ARR") |"
            echo "| $(cat_icon "$ACTIONS_RESULT") | Direct Action Tests (A1-A5) | 5 | $(cat_counts "$ACTIONS_ARR") |"
            echo "| $(cat_icon "$REMOTE_RESULT") | Remote Mode Tests (R1-R12) | 12 | $(cat_counts "$REMOTE_ARR") |"
            echo "| $(cat_icon "$DISCOVER_RESULT") | Discover Mode Tests (D1-D3) | 3 | $(cat_counts "$DISCOVER_ARR") |"
            echo "| $(cat_icon "$COMBO_RESULT") | Combination Tests (C1-C15) | 15 | $(cat_counts "$COMBO_ARR") |"
            echo "| $(cat_icon "$SCN_RESULT") | SCN Detector Tests (S1-S15) | 15 | $(cat_counts "$SCN_ARR") |"
            echo "| $(cat_icon "$I1") | Infrastructure Scan (I1) | 1 | $([ "$I1_STATUS" = "pass" ] && echo "1" || echo "0")/1 |"
            echo "| $(cat_icon "$I2") | No Hardcoded URLs (I2) | 1 | $([ "$I2_STATUS" = "pass" ] && echo "1" || echo "0")/1 |"
            echo ""
            echo "---"
            echo ""

            # ---- Section: Unit Tests ----
            echo "### Unit Tests"
            echo ""
            echo "| Status | ID | Name | Detail | Log |"
            echo "|--------|----|------|--------|-----|"
            echo "$UNIT_ARR" | jq -r --arg url "$RUN_URL" \
              '.[] | "| \(if .status == "pass" then ":white_check_mark:" elif .status == "FAIL" then ":x:" elif .status == "skip" then ":next_track_button:" else ":grey_question:" end) | \(.id) | \(.name) | \(.detail) | [log](\($url)) |"'
            echo ""

            # ---- Section: Direct Action Tests ----
            echo "### Direct Action Tests"
            echo ""
            echo "| Status | ID | Name | Detail | Log |"
            echo "|--------|----|------|--------|-----|"
            echo "$ACTIONS_ARR" | jq -r --arg url "$RUN_URL" \
              '.[] | "| \(if .status == "pass" then ":white_check_mark:" elif .status == "FAIL" then ":x:" elif .status == "skip" then ":next_track_button:" else ":grey_question:" end) | \(.id) | \(.name) | \(.detail) | [log](\($url)) |"'
            echo ""

            # ---- Section: Remote Mode Tests ----
            echo "### Remote Mode Tests"
            echo ""
            echo "| Status | ID | Name | Detail | Log |"
            echo "|--------|----|------|--------|-----|"
            echo "$REMOTE_ARR" | jq -r --arg url "$RUN_URL" \
              '.[] | "| \(if .status == "pass" then ":white_check_mark:" elif .status == "FAIL" then ":x:" elif .status == "skip" then ":next_track_button:" else ":grey_question:" end) | \(.id) | \(.name) | \(.detail) | [log](\($url)) |"'
            echo ""

            # ---- Section: Discover Mode Tests ----
            echo "### Discover Mode Tests"
            echo ""
            echo "| Status | ID | Name | Detail | Log |"
            echo "|--------|----|------|--------|-----|"
            echo "$DISCOVER_ARR" | jq -r --arg url "$RUN_URL" \
              '.[] | "| \(if .status == "pass" then ":white_check_mark:" elif .status == "FAIL" then ":x:" elif .status == "skip" then ":next_track_button:" else ":grey_question:" end) | \(.id) | \(.name) | \(.detail) | [log](\($url)) |"'
            echo ""

            # ---- Section: Combination Tests ----
            echo "### Combination Tests"
            echo ""
            echo "| Status | ID | Name | Detail | Log |"
            echo "|--------|----|------|--------|-----|"
            echo "$COMBO_ARR" | jq -r --arg url "$RUN_URL" \
              '.[] | "| \(if .status == "pass" then ":white_check_mark:" elif .status == "FAIL" then ":x:" elif .status == "skip" then ":next_track_button:" else ":grey_question:" end) | \(.id) | \(.name) | \(.detail) | [log](\($url)) |"'
            echo ""

            # ---- Section: SCN Detector Tests ----
            echo "### SCN Detector Tests"
            echo ""
            echo "| Status | ID | Name | Detail | Log |"
            echo "|--------|----|------|--------|-----|"
            echo "$SCN_ARR" | jq -r --arg url "$RUN_URL" \
              '.[] | "| \(if .status == "pass" then ":white_check_mark:" elif .status == "FAIL" then ":x:" elif .status == "skip" then ":next_track_button:" else ":grey_question:" end) | \(.id) | \(.name) | \(.detail) | [log](\($url)) |"'
            echo ""

            # ---- Section: Regression Tests ----
            echo "### Regression Tests"
            echo ""
            echo "| Status | ID | Name | Detail | Log |"
            echo "|--------|----|------|--------|-----|"
            echo "$REGRESSION_ARR" | jq -r --arg url "$RUN_URL" \
              '.[] | "| \(if .status == "pass" then ":white_check_mark:" elif .status == "FAIL" then ":x:" elif .status == "skip" then ":next_track_button:" else ":grey_question:" end) | \(.id) | \(.name) | \(.detail) | [log](\($url)) |"'
            echo ""

            echo "---"
            echo ""
            echo "**Total: $TOTAL tests** &nbsp; :white_check_mark: $PASSED passed &nbsp; :x: $FAILED failed &nbsp; :next_track_button: $SKIPPED skipped"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if any test category failed
        id: verdict
        env:
          UNIT: ${{ needs.unit-tests.result }}
          ACTIONS: ${{ needs.action-tests.result }}
          REMOTE: ${{ needs.remote-tests.result }}
          DISCOVER: ${{ needs.discover-tests.result }}
          COMBO: ${{ needs.combination-tests.result }}
          SCN: ${{ needs.scn-tests.result }}
          I1: ${{ needs.i1-infrastructure-scan.result }}
          I2: ${{ needs.i2-no-hardcoded-urls.result }}
        run: |
          FAILED=0
          for result in "$UNIT" "$ACTIONS" "$REMOTE" "$DISCOVER" "$COMBO" "$SCN" "$I1" "$I2"; do
            [ "$result" = "failure" ] && FAILED=$((FAILED + 1))
          done

          if [ "$FAILED" -gt 0 ]; then
            echo "suite_failed=true" >> "$GITHUB_OUTPUT"
            echo "::error::$FAILED test category(ies) failed"
          else
            echo "suite_failed=false" >> "$GITHUB_OUTPUT"
            echo "All test categories passed or were skipped"
          fi

      # ---- Dashboard generation & deployment ----
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve hardening action ref
        id: hardening-ref
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HARDENING_REPO="huntridge-labs/hardening-workflows"
          HARDENING_REF="feat/migrate-to-composite-actions"

          # Resolve the commit SHA for the branch
          HARDENING_SHA=$(gh api "repos/${HARDENING_REPO}/commits/${HARDENING_REF}" --jq '.sha' 2>/dev/null || echo "unknown")
          HARDENING_SHA_SHORT="${HARDENING_SHA:0:7}"

          echo "hardening_repo=${HARDENING_REPO}" >> "$GITHUB_OUTPUT"
          echo "hardening_ref=${HARDENING_REF}" >> "$GITHUB_OUTPUT"
          echo "hardening_sha=${HARDENING_SHA}" >> "$GITHUB_OUTPUT"
          echo "hardening_sha_short=${HARDENING_SHA_SHORT}" >> "$GITHUB_OUTPUT"

          echo "Resolved ${HARDENING_REPO}@${HARDENING_REF} to ${HARDENING_SHA_SHORT}"

      - name: Fetch previous history.json
        run: |
          mkdir -p _site
          # Try to fetch history.json from the GitHub API (gh-pages branch or pages artifact)
          PAGES_URL="https://${{ github.repository_owner }}.github.io/$(echo '${{ github.repository }}' | cut -d/ -f2)/history.json"
          curl -sSf "$PAGES_URL" -o _site/history.json 2>/dev/null || echo '[]' > _site/history.json
          # Validate JSON
          jq empty _site/history.json 2>/dev/null || echo '[]' > _site/history.json
          echo "History entries loaded: $(jq 'length' _site/history.json)"

      - name: Generate dashboard
        env:
          ALL_JSON: ${{ env.ALL_JSON }}
          UNIT_JSON: ${{ needs.unit-tests.outputs.results }}
          ACTIONS_JSON: ${{ needs.action-tests.outputs.results }}
          REMOTE_JSON: ${{ needs.remote-tests.outputs.results }}
          DISCOVER_JSON: ${{ needs.discover-tests.outputs.results }}
          COMBO_JSON: ${{ needs.combination-tests.outputs.results }}
          SCN_JSON: ${{ needs.scn-tests.outputs.results }}
          REGRESSION_JSON: ${{ env.REGRESSION_JSON }}
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          ACTIONS_RESULT: ${{ needs.action-tests.result }}
          REMOTE_RESULT: ${{ needs.remote-tests.result }}
          DISCOVER_RESULT: ${{ needs.discover-tests.result }}
          COMBO_RESULT: ${{ needs.combination-tests.result }}
          SCN_RESULT: ${{ needs.scn-tests.result }}
          I1_RESULT: ${{ needs.i1-infrastructure-scan.result }}
          I2_RESULT: ${{ needs.i2-no-hardcoded-urls.result }}
          SCOPE: ${{ inputs.scope || 'all' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
          PAGES_DIR: _site
          HARDENING_REPO: ${{ steps.hardening-ref.outputs.hardening_repo }}
          HARDENING_REF: ${{ steps.hardening-ref.outputs.hardening_ref }}
          HARDENING_SHA: ${{ steps.hardening-ref.outputs.hardening_sha }}
          HARDENING_SHA_SHORT: ${{ steps.hardening-ref.outputs.hardening_sha_short }}
        run: bash .github/scripts/generate-dashboard.sh

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Fail job if suite failed
        if: steps.verdict.outputs.suite_failed == 'true'
        run: exit 1
