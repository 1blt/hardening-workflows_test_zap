name: HRL ZAP Configuration Tests

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'Test configuration'
        required: true
        type: choice
        options:
          - full-coverage  # 7 tests, sequential, target-friendly
          - minimal        # 2 URL scans
          - docker         # 1 Docker scan only
        default: 'full-coverage'

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  # =============================================================================
  # FULL COVERAGE MODE - 7 tests run SEQUENTIALLY
  # =============================================================================
  # Target-friendly: one test at a time, no parallel hammering
  # =============================================================================

  test-1:
    name: "1/7 URL Baseline"
    if: inputs.config == 'full-coverage'
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-1-baseline.yml
    secrets: inherit

  test-2:
    name: "2/7 URL Full"
    if: inputs.config == 'full-coverage'
    needs: test-1
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-2-full.yml
    secrets: inherit

  test-3:
    name: "3/7 URL API"
    if: inputs.config == 'full-coverage'
    needs: test-2
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-3-api.yml
    secrets: inherit

  test-4:
    name: "4/7 Threshold High"
    if: inputs.config == 'full-coverage'
    needs: test-3
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-4-threshold.yml
    secrets: inherit

  test-5:
    name: "5/7 Threshold Medium"
    if: inputs.config == 'full-coverage'
    needs: test-4
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-5-medium.yml
    secrets: inherit

  test-6:
    name: "6/7 Short Duration"
    if: inputs.config == 'full-coverage'
    needs: test-5
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-6-duration.yml
    secrets: inherit

  test-7:
    name: "7/7 Docker Mode"
    if: inputs.config == 'full-coverage'
    needs: test-6
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/test-7-docker.yml
    secrets: inherit

  # =============================================================================
  # SINGLE CONFIG MODES
  # =============================================================================

  single-config:
    name: "ZAP Scan (${{ inputs.config }})"
    if: inputs.config != 'full-coverage'
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/${{ inputs.config }}-test.yml
    secrets: inherit

  # =============================================================================
  # GO/NO-GO REPORT
  # =============================================================================

  summary:
    name: "GO/NO-GO Report"
    runs-on: ubuntu-latest
    needs: [test-1, test-2, test-3, test-4, test-5, test-6, test-7, single-config]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Report
        env:
          T1: ${{ needs.test-1.result }}
          T2: ${{ needs.test-2.result }}
          T3: ${{ needs.test-3.result }}
          T4: ${{ needs.test-4.result }}
          T5: ${{ needs.test-5.result }}
          T6: ${{ needs.test-6.result }}
          T7: ${{ needs.test-7.result }}
          SINGLE: ${{ needs.single-config.result }}
          CONFIG: ${{ inputs.config }}
        run: |
          echo "# ZAP Configuration Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`$CONFIG\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** Sequential (target-friendly)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CONFIG" = "full-coverage" ]; then
            PASSED=0
            TOTAL=7

            for r in "$T1" "$T2" "$T3" "$T4" "$T5" "$T6" "$T7"; do
              [ "$r" = "success" ] && PASSED=$((PASSED + 1))
            done

            PASS_RATE=$((PASSED * 100 / TOTAL))
            [ $PASSED -eq $TOTAL ] && DECISION="GO" || DECISION="NO-GO"
            [ "$DECISION" = "GO" ] && ICON="[PASS]" || ICON="[FAIL]"

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## $ICON DETERMINATION: $DECISION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pass Rate:** $PASSED/$TOTAL ($PASS_RATE%)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| # | Test | Mode | Type | Threshold | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|---|------|------|------|-----------|--------|" >> $GITHUB_STEP_SUMMARY

            fmt() { [ "$1" = "success" ] && echo "[PASS]" || echo "[FAIL]"; }

            echo "| 1 | url-baseline | url | baseline | none | $(fmt $T1) $T1 |" >> $GITHUB_STEP_SUMMARY
            echo "| 2 | url-full | url | full | none | $(fmt $T2) $T2 |" >> $GITHUB_STEP_SUMMARY
            echo "| 3 | url-api | url | api | none | $(fmt $T3) $T3 |" >> $GITHUB_STEP_SUMMARY
            echo "| 4 | threshold-high | url | baseline | high | $(fmt $T4) $T4 |" >> $GITHUB_STEP_SUMMARY
            echo "| 5 | threshold-medium | url | baseline | medium | $(fmt $T5) $T5 |" >> $GITHUB_STEP_SUMMARY
            echo "| 6 | short-duration | url | baseline | none | $(fmt $T6) $T6 |" >> $GITHUB_STEP_SUMMARY
            echo "| 7 | docker-baseline | docker | baseline | none | $(fmt $T7) $T7 |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Variables Covered" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Variable | Values Tested |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|---------------|" >> $GITHUB_STEP_SUMMARY
            echo "| scan_mode | url (1-6), docker-run (7) |" >> $GITHUB_STEP_SUMMARY
            echo "| scan_type | baseline (1,4,5,6,7), full (2), api (3) |" >> $GITHUB_STEP_SUMMARY
            echo "| fail_on_severity | none (1,2,3,6,7), medium (5), high (4) |" >> $GITHUB_STEP_SUMMARY
            echo "| max_duration_minutes | 1 (6), 2 (4,5,7), 3 (1,3), 5 (2) |" >> $GITHUB_STEP_SUMMARY
            echo "| api_spec | test 3 |" >> $GITHUB_STEP_SUMMARY
            echo "| container | test 7 (podinfo) |" >> $GITHUB_STEP_SUMMARY

          else
            [ "$SINGLE" = "success" ] && DECISION="GO" || DECISION="NO-GO"
            [ "$DECISION" = "GO" ] && ICON="[PASS]" || ICON="[FAIL]"

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## $ICON DETERMINATION: $DECISION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| $CONFIG | $ICON $SINGLE |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$DECISION" = "NO-GO" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check failed job logs for specific errors." >> $GITHUB_STEP_SUMMARY
          fi
