name: HRL ZAP Configuration Tests

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'ZAP config file to use'
        required: true
        type: choice
        options:
          - minimal       # 3 scans, target-friendly
          - comprehensive # 6 scans, full coverage
        default: 'minimal'

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  # =============================================================================
  # CONFIG-BASED ZAP TESTING
  # =============================================================================
  # Uses scan_groups defined in config files:
  # - minimal: 3 scans (url-baseline, threshold-test, docker-baseline)
  # - comprehensive: 6 scans (matches PR example)
  # =============================================================================

  zap-scan:
    name: "ZAP Scan (${{ inputs.config }})"
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_config_file: data/zap-configs/${{ inputs.config }}-test.yml
      allow_failure: true
    secrets: inherit

  # =============================================================================
  # GO/NO-GO DETERMINATION
  # =============================================================================

  summary:
    name: "GO/NO-GO Report"
    runs-on: ubuntu-latest
    needs: [zap-scan]
    if: always()
    steps:
      - name: Checkout for config info
        uses: actions/checkout@v4

      - name: Generate Report
        env:
          SCAN_RESULT: ${{ needs.zap-scan.result }}
          CONFIG: ${{ inputs.config }}
        run: |
          # Determine GO/NO-GO
          if [ "$SCAN_RESULT" = "success" ]; then
            DECISION="GO"
            ICON="[PASS]"
          else
            DECISION="NO-GO"
            ICON="[FAIL]"
          fi

          echo "# $ICON DETERMINATION: $DECISION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`data/zap-configs/${CONFIG}-test.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`huntridge-labs/hardening-workflows@feat/zap-scanner\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Scan Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ZAP Scan Job | $ICON $SCAN_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Mode | $CONFIG |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Config File Contents" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          cat "data/zap-configs/${CONFIG}-test.yml" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SCAN_RESULT" = "failure" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Check ZAP job logs** for scan execution errors" >> $GITHUB_STEP_SUMMARY
            echo "2. **Check annotations** for artifact conflicts" >> $GITHUB_STEP_SUMMARY
            echo "3. **Verify config syntax** matches the schema" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage ($CONFIG mode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CONFIG" = "minimal" ]; then
            echo "| Feature | Tested |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| URL scan mode | url-baseline, threshold-test |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker scan mode | docker-baseline |" >> $GITHUB_STEP_SUMMARY
            echo "| Baseline scan type | All scans |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold: none | url-baseline, docker-baseline |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold: high | threshold-test |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** Minimal config uses only demo.testfire.net + podinfo to minimize external load." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Feature | Tested |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| URL scan mode | url-baseline, url-full, url-api, threshold-* |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker scan mode | docker-baseline |" >> $GITHUB_STEP_SUMMARY
            echo "| Baseline scan | url-baseline, threshold-*, docker-baseline |" >> $GITHUB_STEP_SUMMARY
            echo "| Full scan | url-full |" >> $GITHUB_STEP_SUMMARY
            echo "| API scan | url-api |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold: none | url-baseline, threshold-none |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold: high | threshold-high |" >> $GITHUB_STEP_SUMMARY
          fi
