name: HRL ZAP Configuration Tests

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'ZAP config file to use'
        required: true
        type: choice
        options:
          - minimal       # 2 URL scans (baseline + threshold)
          - docker        # 1 Docker scan (podinfo)
          - comprehensive # 5 URL scans (full coverage)
        default: 'minimal'

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  # =============================================================================
  # CONFIG-BASED ZAP TESTING
  # =============================================================================
  # Uses scanner-zap-from-config.yml for config-driven scans
  # Config files define target mode and list of scans
  # =============================================================================

  zap-scan:
    name: "ZAP Scan (${{ inputs.config }})"
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/${{ inputs.config }}-test.yml
    secrets: inherit

  # =============================================================================
  # GO/NO-GO DETERMINATION
  # =============================================================================

  summary:
    name: "GO/NO-GO Report"
    runs-on: ubuntu-latest
    needs: [zap-scan]
    if: always()
    steps:
      - name: Checkout for config info
        uses: actions/checkout@v4

      - name: Generate Report
        env:
          SCAN_RESULT: ${{ needs.zap-scan.result }}
          CONFIG: ${{ inputs.config }}
        run: |
          # Determine GO/NO-GO
          if [ "$SCAN_RESULT" = "success" ]; then
            DECISION="GO"
            ICON="[PASS]"
          else
            DECISION="NO-GO"
            ICON="[FAIL]"
          fi

          echo "# $ICON DETERMINATION: $DECISION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`data/zap-configs/${CONFIG}-test.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`scanner-zap-from-config.yml@feat/zap-scanner\`" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Scan Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ZAP Config Scan | $ICON $SCAN_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Mode | $CONFIG |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Config File" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          cat "data/zap-configs/${CONFIG}-test.yml" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SCAN_RESULT" = "failure" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Check **Parse ZAP Config** job for config syntax errors" >> $GITHUB_STEP_SUMMARY
            echo "2. Check individual scan jobs for ZAP execution errors" >> $GITHUB_STEP_SUMMARY
            echo "3. Check **Annotations** tab for artifact conflicts" >> $GITHUB_STEP_SUMMARY
            echo "4. Verify target URLs are accessible" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "$CONFIG" in
            minimal)
              echo "| Feature | Scans |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| URL mode | url-baseline, threshold-test |" >> $GITHUB_STEP_SUMMARY
              echo "| Baseline scan | Both scans |" >> $GITHUB_STEP_SUMMARY
              echo "| Threshold: none | url-baseline |" >> $GITHUB_STEP_SUMMARY
              echo "| Threshold: high | threshold-test |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> Uses only demo.testfire.net to minimize external load" >> $GITHUB_STEP_SUMMARY
              ;;
            docker)
              echo "| Feature | Scans |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Docker mode | docker-baseline |" >> $GITHUB_STEP_SUMMARY
              echo "| Baseline scan | docker-baseline |" >> $GITHUB_STEP_SUMMARY
              echo "| Container | podinfo:latest |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> Self-contained test - no external target load" >> $GITHUB_STEP_SUMMARY
              ;;
            comprehensive)
              echo "| Feature | Scans |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| URL mode | All 5 scans |" >> $GITHUB_STEP_SUMMARY
              echo "| Baseline scan | url-baseline, threshold-* |" >> $GITHUB_STEP_SUMMARY
              echo "| Full scan | url-full |" >> $GITHUB_STEP_SUMMARY
              echo "| API scan | url-api |" >> $GITHUB_STEP_SUMMARY
              echo "| Threshold: none | url-baseline, threshold-none |" >> $GITHUB_STEP_SUMMARY
              echo "| Threshold: high | threshold-high |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
