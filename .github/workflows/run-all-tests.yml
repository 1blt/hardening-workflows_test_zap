name: HRL ZAP Configuration Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        type: choice
        options:
          - all
          - url-only
          - docker-only
        default: 'all'

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  # =============================================================================
  # MINIMAL TEST SUITE - Maximum coverage with minimum tests
  # =============================================================================
  # Tests cover:
  # - Scan modes: url, docker-run
  # - Scan types: baseline, full, api
  # - Thresholds: none (never fail), high (strict)
  # =============================================================================

  # Test 1: URL Mode + Baseline Scan (most common use case)
  test-url-baseline:
    name: "Test 1: URL + Baseline"
    if: inputs.test_suite == 'all' || inputs.test_suite == 'url-only'
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://testphp.vulnweb.com'
      allow_failure: true
    secrets: inherit

  # Test 2: URL Mode + Full Scan (tests active scanning)
  test-url-full:
    name: "Test 2: URL + Full Scan"
    if: inputs.test_suite == 'all' || inputs.test_suite == 'url-only'
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'full'
      zap_target_urls: 'http://demo.testfire.net'
      allow_failure: true
    secrets: inherit

  # Test 3: URL Mode + API Scan (tests OpenAPI spec scanning)
  test-url-api:
    name: "Test 3: URL + API Scan"
    if: inputs.test_suite == 'all' || inputs.test_suite == 'url-only'
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'api'
      zap_target_urls: 'https://petstore.swagger.io/v2'
      zap_api_spec: 'https://petstore.swagger.io/v2/swagger.json'
      allow_failure: true
    secrets: inherit

  # Test 4: Docker Mode + Baseline (tests container scanning)
  test-docker-baseline:
    name: "Test 4: Docker + Baseline"
    if: inputs.test_suite == 'all' || inputs.test_suite == 'docker-only'
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'docker-run'
      zap_scan_type: 'baseline'
      zap_app_image_ref: 'bkimminich/juice-shop:latest'
      zap_app_ports: '3000:3000'
      zap_target_urls: 'http://localhost:3000'
      allow_failure: true
    secrets: inherit

  # Test 5: Threshold None (tests report-only mode)
  test-threshold-none:
    name: "Test 5: Threshold = None"
    if: inputs.test_suite == 'all' || inputs.test_suite == 'url-only'
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://zero.webappsecurity.com'
      severity_threshold: 'none'
      allow_failure: true
    secrets: inherit

  # Test 6: Threshold High (tests strict failure mode)
  test-threshold-high:
    name: "Test 6: Threshold = High"
    if: inputs.test_suite == 'all' || inputs.test_suite == 'url-only'
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://hackazon.webscantest.com'
      severity_threshold: 'high'
      allow_failure: false
    secrets: inherit

  # =============================================================================
  # CONFIGURATION TEST REPORT
  # =============================================================================

  test-summary:
    name: Configuration Test Report
    runs-on: ubuntu-latest
    needs:
      - test-url-baseline
      - test-url-full
      - test-url-api
      - test-docker-baseline
      - test-threshold-none
      - test-threshold-high
    if: always()
    steps:
      - name: Generate Configuration Test Report
        run: |
          echo "# HRL ZAP Scanner Configuration Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Testing **huntridge-labs/hardening-workflows@feat/zap-scanner**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| # | Test | Configuration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | URL + Baseline | mode=url, type=baseline | ${{ needs.test-url-baseline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | URL + Full Scan | mode=url, type=full | ${{ needs.test-url-full.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | URL + API Scan | mode=url, type=api | ${{ needs.test-url-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Docker + Baseline | mode=docker-run, type=baseline | ${{ needs.test-docker-baseline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Threshold None | severity_threshold=none | ${{ needs.test-threshold-none.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 6 | Threshold High | severity_threshold=high, allow_failure=false | ${{ needs.test-threshold-high.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Coverage Matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Dimension | Values Tested |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Modes | url, docker-run |" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Types | baseline, full, api |" >> $GITHUB_STEP_SUMMARY
          echo "| Thresholds | none, high |" >> $GITHUB_STEP_SUMMARY
          echo "| Failure Modes | allow_failure=true, allow_failure=false |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary Statistics
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PASSED=0
          FAILED=0
          SKIPPED=0

          for result in \
            "${{ needs.test-url-baseline.result }}" \
            "${{ needs.test-url-full.result }}" \
            "${{ needs.test-url-api.result }}" \
            "${{ needs.test-docker-baseline.result }}" \
            "${{ needs.test-threshold-none.result }}" \
            "${{ needs.test-threshold-high.result }}"; do
            case "$result" in
              success) ((PASSED++)) ;;
              failure) ((FAILED++)) ;;
              skipped) ((SKIPPED++)) ;;
            esac
          done

          TOTAL=$((PASSED + FAILED + SKIPPED))

          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List configurations that don't work
          if [ $FAILED -gt 0 ]; then
            echo "### Configurations That Don't Work" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            [[ "${{ needs.test-url-baseline.result }}" == "failure" ]] && echo "- **URL + Baseline**: Basic URL scanning with baseline scan type" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-url-full.result }}" == "failure" ]] && echo "- **URL + Full Scan**: Active scanning with spider/crawler" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-url-api.result }}" == "failure" ]] && echo "- **URL + API Scan**: OpenAPI/Swagger spec scanning" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-docker-baseline.result }}" == "failure" ]] && echo "- **Docker + Baseline**: Container-based application scanning" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-threshold-none.result }}" == "failure" ]] && echo "- **Threshold None**: Report-only mode (severity_threshold=none)" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-threshold-high.result }}" == "failure" ]] && echo "- **Threshold High**: Strict failure mode (allow_failure=false)" >> $GITHUB_STEP_SUMMARY
          fi
