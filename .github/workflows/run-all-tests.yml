name: Run All ZAP Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        type: choice
        options:
          - all
          - basic
        default: 'all'
      zap_source:
        description: 'ZAP workflow source'
        required: true
        type: choice
        options:
          - fork
          - original
        default: 'fork'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  # Test HRL branch (expected to fail - demonstrates Issue #1)
  test-hrl-baseline:
    name: HRL Branch - URL Mode
    if: (inputs.test_suite == 'all' || inputs.test_suite == 'basic') && (github.event_name == 'schedule' || inputs.zap_source == 'original')
    uses: huntridge-labs/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://testphp.vulnweb.com'
      allow_failure: true
    secrets: inherit

  # Test fork with fixes - URL Mode (runs in parallel)
  test-fork-url:
    name: Fork with Fixes - URL Mode
    if: (inputs.test_suite == 'all' || inputs.test_suite == 'basic') && (github.event_name != 'schedule' && inputs.zap_source == 'fork')
    uses: 1blt/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner-fixes-250112
    with:
      scanners: 'zap'
      zap_scan_mode: 'url'
      zap_scan_type: 'baseline'
      zap_target_urls: 'http://demo.testfire.net'
      allow_failure: true
    secrets: inherit

  # Test fork with fixes - Docker Mode (runs in parallel)
  test-fork-docker:
    name: Fork with Fixes - Docker Mode
    if: (inputs.test_suite == 'all' || inputs.test_suite == 'basic') && (github.event_name != 'schedule' && inputs.zap_source == 'fork')
    uses: 1blt/hardening-workflows/.github/workflows/reusable-security-hardening.yml@feat/zap-scanner-fixes-250112
    with:
      scanners: 'zap'
      zap_scan_mode: 'docker-run'
      zap_scan_type: 'baseline'
      zap_app_image_ref: 'bkimminich/juice-shop:latest'
      zap_app_ports: '3000:3000'
      zap_target_urls: 'http://localhost:3000'
      allow_failure: true
    secrets: inherit

  # Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-hrl-baseline, test-fork-url, test-fork-docker]
    if: always()
    steps:
      - name: Check Test Results
        run: |
          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show results based on which source was selected
          if [[ "${{ needs.test-hrl-baseline.result }}" != "skipped" ]]; then
            echo "### HRL Branch (feat/zap-scanner) - Expected to Fail" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| URL Mode (testphp.vulnweb.com) | ${{ needs.test-hrl-baseline.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.test-fork-url.result }}" != "skipped" ]]; then
            echo "### Fork with Fixes (1blt@feat/zap-scanner-fixes-250112)" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| URL Mode (demo.testfire.net) | ${{ needs.test-fork-url.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker Mode (Juice Shop) | ${{ needs.test-fork-docker.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
