name: Test ZAP - Docker Mode (Juice Shop)

on:
  workflow_dispatch:
    inputs:
      workflow_repository:
        description: 'Repository (owner/repo) of hardening-workflows to test'
        required: false
        type: string
        default: 'huntridge-labs/hardening-workflows'
      workflow_ref:
        description: 'Branch/tag of hardening-workflows to test'
        required: false
        type: string
        default: 'feat/zap-scanner'
  workflow_call:
    inputs:
      workflow_repository:
        description: 'Repository (owner/repo) of hardening-workflows to test'
        required: false
        type: string
        default: 'huntridge-labs/hardening-workflows'
      workflow_ref:
        description: 'Branch/tag of hardening-workflows to test'
        required: false
        type: string
        default: 'feat/zap-scanner'
  push:
    branches: [main]
  pull_request:

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  test-zap-baseline:
    name: ZAP Baseline Scan - Juice Shop
    uses: ${{ inputs.workflow_repository || 'huntridge-labs/hardening-workflows' }}/.github/workflows/reusable-security-hardening.yml@${{ inputs.workflow_ref || 'feat/zap-scanner' }}
    with:
      scanners: 'zap'
      zap_scan_mode: 'docker-run'
      zap_scan_type: 'baseline'
      zap_app_image_ref: 'bkimminich/juice-shop:latest'
      zap_app_ports: '3000:3000'
      zap_target_urls: 'http://localhost:3000'
    secrets: inherit

  test-zap-full:
    name: ZAP Full Scan - Juice Shop
    needs: test-zap-baseline
    uses: ${{ inputs.workflow_repository || 'huntridge-labs/hardening-workflows' }}/.github/workflows/reusable-security-hardening.yml@${{ inputs.workflow_ref || 'feat/zap-scanner' }}
    with:
      scanners: 'zap'
      zap_scan_mode: 'docker-run'
      zap_scan_type: 'full'
      zap_app_image_ref: 'bkimminich/juice-shop:latest'
      zap_app_ports: '3000:3000'
      zap_target_urls: 'http://localhost:3000'
    secrets: inherit

  test-zap-api:
    name: ZAP API Scan - Juice Shop
    needs: test-zap-full
    uses: ${{ inputs.workflow_repository || 'huntridge-labs/hardening-workflows' }}/.github/workflows/reusable-security-hardening.yml@${{ inputs.workflow_ref || 'feat/zap-scanner' }}
    with:
      scanners: 'zap'
      zap_scan_mode: 'docker-run'
      zap_scan_type: 'api'
      zap_app_image_ref: 'bkimminich/juice-shop:latest'
      zap_app_ports: '3000:3000'
      zap_target_urls: 'http://localhost:3000'
      zap_api_spec: 'http://localhost:3000/api-docs'
    secrets: inherit
