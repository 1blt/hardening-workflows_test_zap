name: ZAP Reliable Test Suite

on:
  workflow_dispatch:

permissions:
  actions: read
  checks: write
  pull-requests: write
  security-events: write
  id-token: write
  contents: read

jobs:
  juice-shop:
    name: "Juice Shop (4 scans)"
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/reliable-test.yml
    secrets: inherit

  podinfo:
    name: "Podinfo (1 scan)"
    needs: juice-shop
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/reliable-clean.yml
    secrets: inherit

  external:
    name: "External URL (2 scans)"
    needs: podinfo
    uses: huntridge-labs/hardening-workflows/.github/workflows/scanner-zap-from-config.yml@feat/zap-scanner
    with:
      config_file: data/zap-configs/reliable-external.yml
    secrets: inherit

  report:
    name: "Final Report"
    runs-on: ubuntu-latest
    needs: [juice-shop, podinfo, external]
    if: always()
    steps:
      - name: Generate Summary
        env:
          JUICE: ${{ needs.juice-shop.result }}
          POD: ${{ needs.podinfo.result }}
          EXT: ${{ needs.external.result }}
        run: |
          PASSED=0
          FAILED=0
          for r in "$JUICE" "$POD" "$EXT"; do
            [ "$r" = "success" ] && PASSED=$((PASSED + 1)) || FAILED=$((FAILED + 1))
          done

          [ $FAILED -eq 0 ] && STATUS="GO" || STATUS="NO-GO"
          [ "$STATUS" = "GO" ] && ICON="[PASS]" || ICON="[FAIL]"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ZAP Reliable Test Suite

          **Date:** $(date -u '+%Y-%m-%d %H:%M UTC')

          ---

          ## $ICON DETERMINATION: $STATUS

          **Pass Rate:** $PASSED/3 job groups (7 total scans)

          | Job | Scans | Target | Result |
          |-----|-------|--------|--------|
          | Juice Shop | 4 | localhost:3000 | $JUICE |
          | Podinfo | 1 | localhost:9898 | $POD |
          | External | 2 | demo.testfire.net | $EXT |

          ---

          ### Test Coverage

          | # | Test | Type | Threshold |
          |---|------|------|-----------|
          | 1 | juice-baseline | baseline | none |
          | 2 | juice-full | full | none |
          | 3 | threshold-high | baseline | high |
          | 4 | threshold-medium | baseline | medium |
          | 5 | clean-baseline | baseline | medium |
          | 6 | external-baseline | baseline | none |
          | 7 | external-quick | baseline | none |
          EOF
